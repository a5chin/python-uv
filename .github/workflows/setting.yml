name: Configure Repo Settings

on:
  pull_request:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    outputs:
      token: ${{ steps.generate-token.outputs.token }}
    steps:
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}

  delete-branch:
    runs-on: ubuntu-latest

    needs: generate

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Enable auto-delete head branches
        run: |
          gh repo edit ${{ github.repository }} --delete-branch-on-merge
        env:
          GH_TOKEN: ${{ needs.generate.outputs.token }}

  pages:
    runs-on: ubuntu-latest

    needs: generate

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set GitHub Pages Source
        run: |
          gh api -X POST "repos/${{ github.repository }}/pages" \
            -f "source[branch]=${{ env.BRANCH }}" \
            -f "source[path]=${{ env.TARGET_PATH }}" --silent \
          || \
          gh api -X PUT "repos/${{ github.repository }}/pages" \
            -f "source[branch]=${{ env.BRANCH }}" \
            -f "source[path]=${{ env.TARGET_PATH }}"
        env:
          BRANCH: gh-pages
          TARGET_PATH: /
          GH_TOKEN: ${{ needs.generate.outputs.token }}

  protection:
    runs-on: ubuntu-latest

    needs: generate

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Apply Branch Protection Rules
        run: |
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Error: $CONFIG_FILE not found!"
            exit 1
          fi

          for BRANCH in $BRANCHES; do
            if ! gh api "repos/${{ github.repository }}/branches/$BRANCH" --silent >/dev/null 2>&1; then
              echo "Warning: Branch '$BRANCH' does not exist in this repository. Skipping..."
              continue
            fi

            jq -c ".\"$BRANCH\"" "$CONFIG_FILE" > "$BRANCH_protection.json"

            gh api -X PUT "repos/${{ github.repository }}/branches/$BRANCH/protection" \
              --input "$BRANCH_protection.json"
          done
        env:
          CONFIG_FILE: .github/protection.json
          GH_TOKEN: ${{ needs.generate.outputs.token }}
