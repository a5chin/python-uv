name: Repository Settings

on:
  pull_request:
    paths:
      - .github/workflows/setting.yml
      - .github/protection.json
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  delete-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}

      - name: Enable auto-delete head branches
        run: |
          gh repo edit ${{ github.repository }} \
            --delete-branch-on-merge \
            --default-branch develop
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

  pages:
    runs-on: ubuntu-latest

    steps:
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}

      - name: Set GitHub Pages Source
        run: |
          gh api -X POST "repos/${{ github.repository }}/pages" \
            -f "source[branch]=${{ env.BRANCH }}" \
            -f "source[path]=${{ env.TARGET_PATH }}" --silent \
          || \
          gh api -X PUT "repos/${{ github.repository }}/pages" \
            -f "source[branch]=${{ env.BRANCH }}" \
            -f "source[path]=${{ env.TARGET_PATH }}"
        env:
          BRANCH: gh-pages
          TARGET_PATH: /
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

  protection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}

      - name: Apply Branch Protection Rules
        run: |
          if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
            echo "Error: ${{ env.CONFIG_FILE }} not found!"
            exit 1
          fi

          BRANCHES=$(jq -r 'keys[]' "${{ env.CONFIG_FILE }}")

          for BRANCH in $BRANCHES; do
            if ! gh api "repos/${{ github.repository }}/branches/$BRANCH" --silent >/dev/null 2>&1; then
              echo "Warning: Branch '$BRANCH' does not exist in this repository. Skipping..."
              continue
            fi

            jq -c ".\"$BRANCH\"" "$CONFIG_FILE" | gh api -X PUT "repos/${{ github.repository }}/branches/$BRANCH/protection" --input -
          done
        env:
          CONFIG_FILE: .github/protection.json
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

  environments:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - environment: Develop
            branch: develop
          - environment: Production
            branch: main

    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}

      - name: Configure Environment
        run: |
          if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
            echo "Error: ${{ env.CONFIG_FILE }} not found!"
            exit 1
          fi

          jq -c ".\"${{ env.ENVIRONMENT_NAME }}\"" "${{ env.CONFIG_FILE }}" | gh api -X PUT "repos/${{ github.repository }}/environments/${{ env.ENVIRONMENT_NAME }}" --input -

          gh api -X PUT "repos/${{ github.repository }}/environments/${{ env.ENVIRONMENT_NAME }}/deployment-branch-policies" \
            -f "name=${{ env.BRANCH_NAME }}" \
            -f "type=branch"
        env:
          CONFIG_FILE: .github/environments.json
          BRANCH_NAME: ${{ matrix.branch }}
          ENVIRONMENT_NAME: ${{ matrix.environment }}
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
